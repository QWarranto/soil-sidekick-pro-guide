openapi: 3.0.3
info:
  title: SoilSidekick Pro API
  version: 1.0.0
  description: |
    Agricultural intelligence and soil analysis API with tier-based access control.
    
    ## Authentication
    All endpoints require an API key passed via the `Authorization` header:
    ```
    Authorization: Bearer ss_prod_your_api_key_here
    ```
    
    ## Rate Limiting
    Rate limits are enforced based on your subscription tier:
    - **Free**: 10 req/min, 100 req/hour, 1,000 req/day
    - **Starter**: 30 req/min, 500 req/hour, 5,000 req/day
    - **Pro**: 100 req/min, 2,000 req/hour, 25,000 req/day
    - **Enterprise**: 500 req/min, 10,000 req/hour, 100,000 req/day
    
    Rate limit information is returned in response headers:
    - `X-RateLimit-Limit`: Maximum requests in window
    - `X-RateLimit-Remaining`: Remaining requests in window
    - `X-RateLimit-Reset`: Unix timestamp when limit resets
    
  contact:
    name: SoilSidekick Support
    email: support@soilsidekick.com
    url: https://soilsidekick.com/support
  license:
    name: Commercial License
    url: https://soilsidekick.com/license

servers:
  - url: https://your-project.supabase.co/functions/v1
    description: Production server
  - url: http://localhost:54321/functions/v1
    description: Local development server

security:
  - ApiKeyAuth: []

tags:
  - name: Soil Analysis
    description: Soil data and analysis endpoints
  - name: Geographic
    description: County and location-based endpoints
  - name: Water Quality
    description: Water quality assessment
  - name: Satellite Data
    description: Satellite imagery and analysis
  - name: AI Services
    description: AI-powered agricultural intelligence
  - name: VRT
    description: Variable rate technology and prescription maps

paths:
  /get-soil-data:
    post:
      tags:
        - Soil Analysis
      summary: Get soil analysis data
      description: Retrieve comprehensive soil analysis for a specific county
      operationId: getSoilData
      x-tier-required: free
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - county_fips
              properties:
                county_fips:
                  type: string
                  pattern: '^[0-9]{5}$'
                  description: 5-digit FIPS code
                  example: "12345"
      responses:
        '200':
          description: Successful response
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
              description: Maximum requests per window
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: Remaining requests in window
            X-RateLimit-Reset:
              schema:
                type: integer
              description: Unix timestamp when limit resets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SoilData'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/ServerError'

  /county-lookup:
    post:
      tags:
        - Geographic
      summary: Search for counties
      description: Search counties by name, state, or FIPS code
      operationId: countyLookup
      x-tier-required: free
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - term
              properties:
                term:
                  type: string
                  minLength: 2
                  maxLength: 100
                  description: Search term (county name, state, or FIPS)
                  example: "Miami-Dade"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  counties:
                    type: array
                    items:
                      $ref: '#/components/schemas/County'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

  /territorial-water-quality:
    post:
      tags:
        - Water Quality
      summary: Get water quality data
      description: Retrieve water quality metrics for a specific county
      operationId: getWaterQuality
      x-tier-required: starter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - county_fips
              properties:
                county_fips:
                  type: string
                  pattern: '^[0-9]{5}$'
                  example: "12345"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WaterQuality'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'

  /multi-parameter-planting-calendar:
    post:
      tags:
        - Soil Analysis
      summary: Get planting calendar recommendations
      description: Multi-parameter planting calendar with climate and soil factors
      operationId: getPlantingCalendar
      x-tier-required: starter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - county_fips
                - crop_type
              properties:
                county_fips:
                  type: string
                  pattern: '^[0-9]{5}$'
                crop_type:
                  type: string
                  example: "corn"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlantingCalendar'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'

  /alpha-earth-environmental-enhancement:
    post:
      tags:
        - Satellite Data
      summary: Get satellite environmental data
      description: AlphaEarth satellite intelligence integration
      operationId: getSatelliteData
      x-tier-required: pro
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - latitude
                - longitude
              properties:
                latitude:
                  type: number
                  format: float
                  minimum: -90
                  maximum: 90
                longitude:
                  type: number
                  format: float
                  minimum: -180
                  maximum: 180
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SatelliteData'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'

  /agricultural-intelligence:
    post:
      tags:
        - AI Services
      summary: Get AI-powered agricultural insights
      description: Agricultural intelligence with AI recommendations
      operationId: getAgriculturalIntelligence
      x-tier-required: pro
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - county_fips
                - analysis_type
              properties:
                county_fips:
                  type: string
                  pattern: '^[0-9]{5}$'
                analysis_type:
                  type: string
                  enum: [crop_recommendation, yield_prediction, pest_analysis]
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAnalysis'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'

  /generate-vrt-prescription:
    post:
      tags:
        - VRT
      summary: Generate VRT prescription map
      description: Generate variable rate technology prescription maps
      operationId: generateVRTPrescription
      x-tier-required: pro
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - field_id
                - application_type
              properties:
                field_id:
                  type: string
                  format: uuid
                application_type:
                  type: string
                  enum: [fertilizer, seed, pesticide]
                soil_analysis_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VRTPrescription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: Authorization
      description: |
        API key authentication. Format: `Bearer ss_prod_your_api_key`
        
        Obtain your API key from the SoilSidekick dashboard.

  schemas:
    SoilData:
      type: object
      properties:
        id:
          type: string
          format: uuid
        county_fips:
          type: string
        county_name:
          type: string
        state_code:
          type: string
        ph_level:
          type: number
          format: float
        organic_matter:
          type: number
          format: float
        nitrogen_level:
          type: string
        phosphorus_level:
          type: string
        potassium_level:
          type: string
        recommendations:
          type: string
        analysis_data:
          type: object
          additionalProperties: true

    County:
      type: object
      properties:
        id:
          type: string
          format: uuid
        county_name:
          type: string
        state_name:
          type: string
        state_code:
          type: string
        fips_code:
          type: string

    WaterQuality:
      type: object
      properties:
        county_fips:
          type: string
        ph:
          type: number
          format: float
        dissolved_oxygen:
          type: number
          format: float
        turbidity:
          type: number
          format: float
        nitrates:
          type: number
          format: float
        phosphates:
          type: number
          format: float

    PlantingCalendar:
      type: object
      properties:
        crop_type:
          type: string
        optimal_planting_window:
          type: object
          properties:
            start_date:
              type: string
              format: date
            end_date:
              type: string
              format: date
        climate_factors:
          type: object
        soil_factors:
          type: object
        recommendations:
          type: array
          items:
            type: string

    SatelliteData:
      type: object
      properties:
        ndvi:
          type: number
          format: float
          description: Normalized Difference Vegetation Index
        evi:
          type: number
          format: float
          description: Enhanced Vegetation Index
        soil_moisture:
          type: number
          format: float
        temperature:
          type: number
          format: float
        cloud_cover:
          type: number
          format: float

    AIAnalysis:
      type: object
      properties:
        analysis_type:
          type: string
        confidence_score:
          type: number
          format: float
        recommendations:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              description:
                type: string
              priority:
                type: string
                enum: [low, medium, high]

    VRTPrescription:
      type: object
      properties:
        id:
          type: string
          format: uuid
        field_id:
          type: string
          format: uuid
        application_type:
          type: string
        zones:
          type: array
          items:
            type: object
            properties:
              zone_id:
                type: integer
              application_rate:
                type: number
              geometry:
                type: object

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: string

  responses:
    Unauthorized:
      description: Authentication required or invalid API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Authentication required"
            message: "Invalid or missing API key"
            code: "UNAUTHORIZED"

    Forbidden:
      description: Tier restriction - upgrade required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Tier restriction"
            message: "This feature requires Pro tier or higher"
            code: "TIER_RESTRICTED"

    RateLimited:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
        X-RateLimit-Remaining:
          schema:
            type: integer
        X-RateLimit-Reset:
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Rate limit exceeded"
            message: "You have exceeded your rate limit. Retry after reset time."
            code: "RATE_LIMITED"

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Internal server error"
            message: "An unexpected error occurred"
            code: "INTERNAL_ERROR"